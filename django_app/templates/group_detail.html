{% extends 'base.html' %}
{% load staticfiles %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'datatables/dataTables.bootstrap.min.css' %}">
{% endblock %}

{% block content %}
    <section class="content-header">
        <h1>
            班级详情
            <small>
                {{ group.name }}
            </small>
        </h1>
        <ol class="breadcrumb">
            <li>
                <a href="{% url 'index' %}"><i class="fa fa-dashboard"></i> 首页</a>
            </li>
            <li>
                <a href="{% url 'user.groups' %}">班级</a>
            </li>
            <li class="active">详情</li>
        </ol>
    </section>

    <!-- Main content -->
    <section class="content container-fluid">

        <div class="box">
            <div class="box-header">
                <h3>
                    {% if my_role %}
                        <button class="btn btn-success" id="btn-toggle-member">我是班级成员 - 申请退出</button>
                    {% else %}
                        <button class="btn btn-warning" id="btn-toggle-member">我不是班级成员 - 申请加入</button>
                    {% endif %}
                </h3>

            </div>
            <div class="box-body">
            {% if my_role %}
                <!-- 我是成员 -->
                {% if members %}
                    <table class="table table-responsive" id="members_table">
                        <thead>
                        <tr>
                            <th>用户</th>
                            <th>权限</th>
                        </tr>
                        </thead>
                        {% for member in members %}
                            <tr>
                                <td class="user-block">
                                    <a href="{% url 'users.contact' member.user.id %}">
                                    {% if member.user.avatar %}
                                        <img src="{{ MEDIA_URL }}{{ member.user.avatar }}" class="img-circle img-sm" alt="User Image" />
                                    {% endif %}
                                    <span class="username">{{ member.user.nick_name }}</span>
                                    </a>
                                </td>
                                <td>
                                    {{ member.get_role_display }}
                                </td>
                            </tr>
                        {% endfor %}

                    </table>
                {% else %}
                    <p>班级现在没有成员</p>
                {% endif %}
            {% else %}
                <!-- 我不是成员，不能查看成员列表  -->
                班里有哪些人？加入了才能看到。
            {% endif %}
            </div>
        </div>

    </section>

    <!-- 确认加入班级 -->
    <div class="modal fade" id="dialog-confirm-join">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">确定加入班级吗？</h4>
                </div>
                <div class="modal-body margin-bottom">
                    <p>
                        点击“确定”按钮，系统会发送一条消息给班级管理员。等管理员批准以后，你就被加入班级了。
                    </p>
                    <label><input id="check_is_teacher" type="checkbox" />我是老师</label>
                    <p id="join_confirm_msg"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default pull-left" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="confirm_join">确定</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
    </div>
    <!-- /.modal-dialog -->

    <!-- 确认退出班级 -->
    <div class="modal fade" id="dialog-confirm-leave">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">确定退出班级吗？</h4>
                </div>
                <div class="modal-body margin-bottom">
                    <p>
                        点击“确定”按钮，系统会发送一条消息给班级管理员。等管理员批准以后，你就退出班级了。
                    </p>
                    <p id="leave_confirm_msg"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default pull-left" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="confirm_leave">确定</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
    </div>
    <!-- /.modal-dialog -->
{% endblock %}

{% block extra_script %}

    <script src="{% static 'datatables/jquery.dataTables.min.js' %}" ></script>
    <script src="{% static 'datatables/dataTables.bootstrap.min.js' %}"></script>

    <script>
    $(function () {
        {% if my_role %}
            var is_member = true;
        {% else %}
            var is_member = false;
        {% endif %}
        $("#btn-toggle-member").click(function() {
            if (!is_member) {
                $("#confirm_join").removeClass("disabled");
                $("#join_confirm_msg").text("");
                $("#dialog-confirm-join").modal("toggle");
            } else {
                $("#confirm_leave").removeClass("disabled");
                $("#leave_confirm_msg").text("");
                $("#dialog-confirm-leave").modal("toggle");
            }
        });

        $("#confirm_join").click(function() {
            $.ajax({
                type: "POST",
                url: "{% url 'user.join_group' %}",
                beforeSend:function(xhr, settings) {
                    xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
                },
                async: true,
                data: {
                    "group_id": {{ group.id }},
                    "is_teacher": $("#check_is_teacher").get(0).checked
                },
                success: function(data) {
                    try {
                        if (data.status == "success") {
                            $("#join_confirm_msg").text("已经发消息提醒管理员批准。请耐心等待。");
                            $("#confirm_join").addClass("disabled");
                        }
                    } catch (ex) {
                        console.log(ex);
                    }
                }
            });
        });

        $("#confirm_leave").click(function() {
            $.ajax({
                type: "POST",
                url: "{% url 'user.leave_group' %}",
                beforeSend:function(xhr, settings) {
                    xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
                },
                async: true,
                data: {
                    "group_id": {{ group.id }}
                },
                success: function(data) {
                    try {
                        if (data.status == "success") {
                            $("#leave_confirm_msg").text("已经发消息提醒管理员批准。请耐心等待。");
                            $("#confirm_leave").addClass("disabled");
                        }
                    } catch (ex) {
                        console.log(ex);
                    }
                }
            });
        });
    });
    </script>
{% endblock %}