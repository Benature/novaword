{% extends 'base.html' %}

{% block content %}
        <!-- Content Header (Page header) -->
    <section class="content-header">
        <h1>
            单词学习
        </h1>
        <ol class="breadcrumb">
            <li>
                <a href="{% url 'index' %}"><i class="fa fa-dashboard"></i> 首页</a>
            </li>
            <li>
                <a href="{% url 'learn.unit_detail' unit.id %}">单元</a>
            </li>
            <li class="active">单词学习</li>
        </ol>
    </section>

    <!-- Main content -->
    <section class="content container-fluid">
    <div class="box">
        <div class="box-header">
            <h2 id="word-spelling"></h2>
        </div>

        <div class="box-body">
            <div id="answer">
                <a class="btn btn-success" id="btn-familiar">认识</a>
                <a class="btn btn-danger" id="btn-unfamiliar">不熟悉</a>
            </div>

            <div id="word_browser">
                <div>
                    <a id="container_us" class="btn">
                        美 <span class="ion ion-speakerphone text-blue" id="play_us"></span> <span id="pronounciation_us"></span>
                        <audio id="audio_us">
                            <source id="audio_us_src" />
                        </audio>
                    </a>

                    <a id="container_uk" class="btn">
                        英 <span class="ion ion-speakerphone text-blue" id="play_uk"></span> <span id="pronounciation_uk"></span>
                        <audio id="audio_uk">
                            <source id="audio_uk_src" />
                        </audio>
                    </a>
                </div>
                <div id="simple-meaning"></div>
                <div id="simple-meaning-in-dict"></div>

                <a class="btn btn-primary" id="btn-next">继续</a>

            </div>

            <div id="result">
                <a class="btn btn-primary" href="{% url 'learn.unit_detail' unit.id %}">返回单元</a>
                <a class="btn btn-primary" href="{% url 'learn.unit_test' unit.id %}">单元测试</a>
                <a class="btn btn-primary" id="btn-walkthrough">再来一次</a>
            </div>
        </div>

    </div>
    </section>
{% endblock %}

{% block extra_script %}
    <script>
    $(function() {
        var unit_words = null;
        var current_index = 0;
        var url = "{% url 'learn.ajax_unit_data' unit.id %}";
        var start_seconds = 0;
        var finish_seconds = 0;

        $.get(url, function(result) {
            console.log(result);
            unit_words = result["data"];
            start_walk_through();
        });

        function start_walk_through() {
            current_index = 0;
            // we are not familiar with all of the words
            for (var i = 0; i < unit_words.length; i++) {
                var word = unit_words[i];
                word.familiar = false;
            }
            start_seconds = new Date().getTime()/1000;
            continue_walk_through();
        }

        function continue_walk_through() {
            var candidate = null;
            // find a word which I'm still unfamiliar
            for (var i = 1; i <= unit_words.length; i++) {
                var index = (current_index + i) % unit_words.length;
                var word = unit_words[index];
                if (!word.familiar) {
                    // yes we found the word
                    candidate = word;
                    current_index = index;
                    break;
                }
            }
            if (candidate != null) {
                show_word(candidate);
            } else {
                // we are done!
                show_result();
            }
        }

        function show_result() {
            $("#word_browser").hide();
            $("#answer").hide();
            $("#word-spelling").html("学习完成");
            $("#result").show();

            finish_seconds = new Date().getTime()/1000;
            var seconds_used = Math.floor(finish_seconds - start_seconds);
            var data = {
                "unit_id": {{ unit.id }},
                "type": 1,
                "correct_rate": 100,
                "correct_count": 100,
                "word_count": unit_words.length,
                "seconds_used": seconds_used
            };

            // save learning record
            $.ajax({
                type: "POST",
                url: "{% url 'learn.save_record' %}",
                beforeSend:function(xhr, settings) {
                    xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
                },
                async: true,
                data: JSON.stringify(data),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function(data) {
                    try {
                        console.log("record saved");
                    } catch (ex) {
                        console.log(ex);
                    }
                }
            });
        }

        function show_word(word) {
            $("#result").hide();
            $("#word_browser").hide();
            $("#answer").show();
            $("#word-spelling").html(word.spelling);
        }

        function show_word_explain(word) {
            $("#answer").hide();
            $("#word_browser").show();
            // spelling
            $("#word-spelling").text(word.spelling);
            // show pronounciation
            if (word.pronounciation_us) {
                $("#container_us").show();
                $("#pronounciation_us").text(word.pronounciation_us);
                $("#audio_us_src").attr("src", word.mp3_us_url);
            } else {
                $("#container_us").hide();
            }
            if (word.pronounciation_uk) {
                $("#container_uk").show();
                $("#pronounciation_uk").text(word.pronounciation_uk);
                $("#audio_uk_src").attr("src", word.mp3_uk_url);
            } else {
                $("#container_uk").hide();
            }
            // simple meaning
            $("#simple-meaning").text(word.simple_meaning);
            //$("#simple-meaning-in-dict").text(word.short_meaning_in_dict);
        }

        function answer_familiar() {
            var word = unit_words[current_index];
            word.familiar = true;
            show_word_explain(word);
        }

        function answer_unfamiliar() {
            var word = unit_words[current_index];
            show_word_explain(word);
        }

        $("#btn-walkthrough").click(start_walk_through);
        $("#btn-familiar").click(answer_familiar);
        $("#btn-next").click(continue_walk_through);
        $("#btn-unfamiliar").click(answer_unfamiliar);

        $(document).keydown(function(event) {
            if (event.which == 39) {
                answer_familiar();
            } else if (event.which == 37) {
                answer_unfamiliar();
            }
        });

        $("#container_us").click(function() {
            var us = $("#audio_us").get(0);
            us.load();
            us.play();
        });

        $("#container_uk").click(function() {
            var uk = $("#audio_uk").get(0);
            uk.load();
            uk.play();
        });

    });
    </script>
{% endblock %}
